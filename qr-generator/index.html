<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Generator</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="../firebase.js"></script>
<style>
  #qrContainer img { margin: 5px; }
  table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
</style>
</head>
<body>
<h2>QR Generator - Attendance System</h2>

<!-- Admin PIN -->
<input type="password" id="adminPin" placeholder="Enter Admin PIN">
<button onclick="verifyAdmin()">Verify PIN</button>
<hr>

<!-- CSV Upload -->
<input type="file" id="csvUpload" accept=".csv">
<button onclick="processCSV()">Upload CSV & Generate QR</button>
<hr>

<!-- QR Container -->
<div id="qrContainer"></div>

<!-- Employee Table -->
<h3>Employee List</h3>
<table id="employeeTable">
  <thead><tr><th>EmpID</th><th>Name</th><th>Mail</th><th>Bus</th><th>Actions</th></tr></thead>
  <tbody></tbody>
</table>

<button onclick="saveToFirebase()">Save All to DB</button>
<button onclick="deleteAllEntries()">Delete All</button>

<script>
// Admin PIN hash (SHA256 of 1234)
const adminHash = "03ac674216f3e15c761ee1a5e255f067953623c8f966f3b0b0ff9d4a7c1b6d1a";
let adminVerified = false;

function sha256(str) {
    return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str))
        .then(buf => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join(''));
}

async function verifyAdmin(){
  const pin = document.getElementById("adminPin").value;
  const hash = await sha256(pin);
  if(hash === adminHash){
    adminVerified = true;
    alert("Admin verified!");
    loadEmployees();
  } else alert("Incorrect PIN");
}

// Store CSV entries temporarily
let employees = [];

function processCSV(){
  if(!adminVerified){ alert("Verify admin first"); return; }
  const file = document.getElementById("csvUpload").files[0];
  if(!file){ alert("Select CSV"); return; }
  Papa.parse(file, {
    header: true,
    complete: function(results){
      employees = results.data;
      displayEmployees();
      generateQRCodes();
    }
  });
}

function displayEmployees(){
  const tbody = document.querySelector("#employeeTable tbody");
  tbody.innerHTML = "";
  employees.forEach((emp, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${emp.EmpID}</td><td>${emp.Name}</td><td>${emp.Mail}</td><td>${emp.Bus}</td>
                    <td><button onclick="deleteEntry(${idx})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

function generateQRCodes(){
  const container = document.getElementById("qrContainer");
  container.innerHTML = "";
  employees.forEach(emp => {
    const div = document.createElement("div");
    div.id = "qr_"+emp.EmpID;
    const qrData = JSON.stringify({employeeID: emp.EmpID, employeeName: emp.Name, mail: emp.Mail, bus: emp.Bus});
    new QRCode(div, { text: qrData, width: 128, height: 128 });
    const downloadBtn = document.createElement("button");
    downloadBtn.innerText = "Download QR";
    downloadBtn.onclick = ()=>downloadQRCode(div, emp);
    div.appendChild(downloadBtn);
    container.appendChild(div);
  });
}

function downloadQRCode(div, emp){
  const img = div.querySelector("img");
  const link = document.createElement("a");
  link.href = img.src;
  link.download = `${emp.EmpID}_${emp.Name}.png`;
  link.click();
}

// Delete a single entry
function deleteEntry(idx){
  if(confirm("Delete this entry?")){
    employees.splice(idx,1);
    displayEmployees();
    generateQRCodes();
  }
}

// Delete all entries
function deleteAllEntries(){
  if(!adminVerified){ alert("Verify admin first"); return; }
  if(confirm("Delete ALL entries in DB?")){
    const batch = db.batch();
    db.collection("employees").get().then(snapshot=>{
      snapshot.docs.forEach(doc=>{
        batch.delete(doc.ref);
      });
      batch.commit().then(()=>alert("All employees deleted"));
    });
  }
}

// Save all entries to Firebase
function saveToFirebase(){
  if(!adminVerified){ alert("Verify admin first"); return; }
  const batch = db.batch();
  employees.forEach(emp=>{
    const ref = db.collection("employees").doc(emp.EmpID);
    batch.set(ref, {...emp, adminKey: adminHash});
  });
  batch.commit()
    .then(()=>alert("Saved all employees to DB!"))
    .catch(err=>alert("Save failed: "+err));
}

// Load existing employees from DB
function loadEmployees(){
  db.collection("employees").get().then(snapshot=>{
    employees = snapshot.docs.map(doc=>doc.data());
    displayEmployees();
    generateQRCodes();
  });
}
</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
<script src="../firebase.js"></script>

</body>
</html>
