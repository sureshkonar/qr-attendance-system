<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Code Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
    }
    h2 {
        text-align: center;
    }

    .container {
        max-width: 700px;
        margin: auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(0,0,0,0.15);
    }

    input[type="file"], button {
        width: 100%;
        padding: 12px;
        margin-top: 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 15px;
    }

    button {
        background: #007bff;
        color: white;
        cursor: pointer;
        border: none;
    }
    button:hover {
        background: #0056b3;
    }

    #qrPreview img {
        width: 140px;
        margin: 10px;
    }

    #clearBtn {
        background: red;
    }
</style>

</head>

<body>

<script>
// ------------------------------
// ADMIN ACCESS PROTECTION
// ------------------------------
if (!localStorage.getItem("admin_logged_in")) {
    window.location.href = "../admin.html";
}
</script>

<div class="container">
    <h2>QR Code Generator</h2>

    <label><b>Upload CSV File</b></label>
    <input type="file" id="csvFile" accept=".csv">

    <button onclick="processCSV()">Generate QR Codes</button>

    <button id="clearBtn" onclick="clearDatabase()">Clear All Firebase Entries</button>

    <div id="qrPreview"></div>
</div>

<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
<script src="../firebase.js"></script>


<script>
// ------------------------------------------------
// FIREBASE CONFIG  (replace with your credentials)
// ------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyB-cRwUJ8zcb1pWbToYXMtZg76vjhTMUPs",
  authDomain: "attendance-system-b1d37.firebaseapp.com",
  projectId: "attendance-system-b1d37",
  storageBucket: "attendance-system-b1d37.firebasestorage.app",
  messagingSenderId: "298377818582",
  appId: "1:298377818582:web:48222962ad7981828f3477"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// -------------------------------------------
// CSV FORMAT EXPLAINED
// -------------------------------------------
// CSV must be EXACTLY like this:
//
// EmployeeID,EmployeeName
// 12345,John Doe
// 56789,Rahul Kumar
// 99221,Asha Patel
//
// No extra spaces. No extra columns.
// -------------------------------------------

function processCSV() {
    const fileInput = document.getElementById("csvFile");
    if (!fileInput.files.length) {
        alert("Please upload a CSV file");
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const rows = e.target.result.split("\n").map(r => r.trim()).filter(r => r);

        // Skip header row
        rows.shift();

        rows.forEach(row => {
            const [empID, empName] = row.split(",");

            if (!empID || !empName) return;

            const data = {
                employeeID: empID,
                employeeName: empName
            };

            // Save entry to Firebase
            const ref = db.ref("employees/" + empID);
            ref.set(data);

            // Generate QR Code
            QRCode.toDataURL(JSON.stringify(data), { width: 300 }, function (err, url) {
                if (!err) {
                    renderQR(empID, empName, url);
                }
            });
        });

        alert("QR Codes generated!");
    };

    reader.readAsText(file);
}


// ------------------------------------------
// DISPLAY QR + DOWNLOAD BUTTON
// ------------------------------------------
function renderQR(empID, empName, qrURL) {
    const container = document.getElementById("qrPreview");
    const div = document.createElement("div");

    div.innerHTML = `
        <div style="text-align:center; margin:20px;">
            <img src="${qrURL}">
            <br>
            <a href="${qrURL}" download="${empName}_${empID}.png">
                <button style="margin-top:10px;">Download QR</button>
            </a>
        </div>
    `;

    container.appendChild(div);
}


// ------------------------------------------
// DELETE ALL FIREBASE DATA
// ------------------------------------------
function clearDatabase() {
    if (confirm("Are you sure you want to delete ALL QR entries?")) {
        firebase.database().ref("employees").remove()
            .then(() => alert("All entries cleared"))
            .catch(err => alert("Error: " + err));
    }
}
</script>

</body>
</html>
