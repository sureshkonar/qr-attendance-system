<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Attendance Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="header">
    <div class="nav"><a href="index.html">Dashboard</a><a href="qr-generator/index.html">QR Generator</a><a href="scanner/index.html">Scanner</a></div>
  </div>
  <div class="container">
    <h2>Attendance Dashboard</h2>
    <div class="controls">
      <input id="search" placeholder="Search name or id" />
      <button id="exportBtn" class="small-btn">Export XLSX</button>
      <button id="refreshBtn" class="small-btn">Refresh</button>
    </div>

    <div style="margin-top:12px" id="summary" class="hint"></div>

    <div id="busCards" style="display:flex;gap:10px;margin-top:12px"></div>

    <table class="table"><thead><tr><th>EmpID</th><th>Name</th><th>Mail</th><th>Bus</th><th>Timestamp</th><th>ScannedBy</th></tr></thead>
    <tbody id="tbody"></tbody></table>
  </div>

  <script type="module" src="./firebase.js"></script>
  <script type="module">
  import { db } from './firebase.js';
  import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const tbody = document.getElementById('tbody'), summary = document.getElementById('summary'), busCards = document.getElementById('busCards'), search = document.getElementById('search');
  let latest = [];

  onSnapshot(collection(db,'attendance'), snap => {
    latest = [];
    snap.forEach(d => latest.push(d.data()));
    render(latest);
  });

  function render(rows){
    tbody.innerHTML=''; busCards.innerHTML=''; const map = {};
    rows.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
    rows.forEach(r=> {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.employeeID}</td><td>${r.employeeName}</td><td>${r.mail||''}</td><td>${r.bus}</td><td>${new Date(r.timestamp).toLocaleString()}</td><td>${r.scannedBy||''}</td>`;
      tbody.appendChild(tr);
      map[r.bus] = (map[r.bus]||0)+1;
    });
    document.getElementById('summary').textContent = `Total present: ${rows.length}`;
    Object.keys(map).sort().forEach(b => {
      const el = document.createElement('div'); el.className='card'; el.style.padding='10px'; el.innerHTML = `<strong>${b}</strong><div>${map[b]}</div>`; busCards.appendChild(el);
    });
  }

  search.addEventListener('input', ()=> {
    const q = search.value.toLowerCase();
    if(!q) return render(latest);
    render(latest.filter(r=> (r.employeeName||'').toLowerCase().includes(q) || (r.employeeID||'').toLowerCase().includes(q) ));
  });

  document.getElementById('exportBtn').addEventListener('click', async ()=> {
    if(!latest.length){ alert('No data'); return; }
    const rows = [['EmpID','Name','Mail','Bus','Timestamp','ScannedBy']];
    latest.forEach(r=> rows.push([r.employeeID,r.employeeName,r.mail||'',r.bus,r.timestamp,r.scannedBy||'']));
    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(rows); XLSX.utils.book_append_sheet(wb,ws,'Attendance');
    const wbout = XLSX.write(wb,{bookType:'xlsx',type:'array'});
    const blob = new Blob([wbout],{type:'application/octet-stream'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='attendance_export.xlsx'; a.click(); URL.revokeObjectURL(url);
  });

  // load XLSX lib dynamic
  import("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");
  </script>
</body>
</html>
