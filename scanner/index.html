<!DOCTYPE html>
<html>
<head>
  <title>Attendance Scanner</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    // -------------------------------------
    // FIREBASE CONFIGURATION (SET YOUR KEYS)
    // -------------------------------------
    const firebaseConfig = {
    apiKey: "AIzaSyB-cRwUJ8zcb1pWbToYXMtZg76vjhTMUPs",
    authDomain: "attendance-system-b1d37.firebaseapp.com",
    projectId: "attendance-system-b1d37",
    storageBucket: "attendance-system-b1d37.firebasestorage.app",
    messagingSenderId: "298377818582",
    appId: "1:298377818582:web:48222962ad7981828f3477"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let selectedBus = "Bus 1";
    function setBus(bus) {
        selectedBus = bus;
        alert("Bus selected: " + bus);
    }

    async function markAttendance(id, name) {
        const ref = doc(db, "attendance", id);
        const existing = await getDoc(ref);

        if (existing.exists()) {
            alert("Already Marked: " + name);
            return;
        }

        await setDoc(ref, {
            name: name,
            bus: selectedBus,
            timestamp: new Date().toISOString()
        });

        alert("Marked: " + name);
    }

    window.onload = () => {
        const codeReader = new ZXing.BrowserQRCodeReader();

        document.getElementById("scanBtn").onclick = () => {
            codeReader.decodeFromVideoDevice(undefined, "video", (result, err) => {
                if (result) {
                    let data = JSON.parse(result.text);
                    markAttendance(data.id, data.name);
                }
            });
        };
    };
  </script>
  <script type="module" src="../firebase.js"></script>


  <style>
    body { font-family: Arial; padding: 20px; text-align: center; }
    video { width: 90%; border: 2px solid black; }
  </style>
</head>

<body>
<h2>Attendance Scanner</h2>

<select onchange="setBus(this.value)">
  <option>Bus 1</option>
  <option>Bus 2</option>
  <option>Bus 3</option>
  <option>Bus 4</option>
  <option>Bus 5</option>
</select>

<br><br>

<button id="scanBtn">Start Scanning</button>

<br><br>

<video id="video"></video>

</body>
</html>
